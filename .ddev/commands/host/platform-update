#!/bin/bash

## Description: Update composer dependencies and rebuild yarn cache if needed.
source .conf/settings
echo "Checking for updates..."
updates=$(ddev composer update -o --no-install 2>&1)
echo "${updates}"
if [[ "$updates" != *"Nothing to modify in lock file"* ]]; then
  ddev composer install -o --prefer-source
fi
if [[ "${NODE_VER}" != '10' ]]; then
  ddev yarn-upgrade
elif [[ "$updates" == *"set-design"* ]] || [[ "$updates" == *"vc-library"* ]] || [[ "$updates" == *"situation/scripts"* ]] || [[ "$updates" == *"quiz-builder"* ]]; then
  touch .ddev/.updated
  echo "Found platform updates, rebuilding yarn cache..."
  ddev yarn-install
  rm -f .ddev/.updated
fi
ddev mutagen sync
