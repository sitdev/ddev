#!/usr/bin/env bash

## Description: Run Vite HMR dev servers for all targets sequentially
## to avoid port conflicts, then let them run concurrently.

# Assuming these variables are set in your environment or the sourced file:
# buildTargets: An array of paths to your Vite projects.
# E.g., buildTargets=("./packages/app-one" "./packages/app-two")

export scriptRoot=$(dirname "$(realpath "${BASH_SOURCE[0]}")")
if [ -f "$scriptRoot/.utilities" ]; then
    source "$scriptRoot/.utilities"
fi

# Function to gracefully shut down all background processes on exit
cleanup() {
    echo -e "\n\nShutting down all dev servers..."
    # The 'pkill' command with -P $$ targets child processes of the current script
    pkill -P $$
    echo "Done."
}

# Trap the EXIT signal (e.g., from Ctrl+C) to run the cleanup function
trap cleanup EXIT

echo "Preparing dev server..."
for target in "${buildTargets[@]}"; do
    targetName=$(basename "$target")
    (
        cd "$target"
        pnpm install
    ) >/dev/null 2>&1
done
for target in "${buildTargets[@]}"; do
    targetName=$(basename "$target")
    echo "--- Starting dev server for: ${targetName} ---"
    (
        cd "$target"
        # The output of each server will be prefixed with its name
        pnpm run dev | sed "s/^/[${targetName}] /"
    ) &

    # Give Vite a moment to initialize and claim a port.
    # You can adjust this duration if your projects take longer to start.
    sleep 2
    echo ""
done

wait