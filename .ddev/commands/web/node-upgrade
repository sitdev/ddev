#!/usr/bin/env bash

## Description: Upgrade package.json

# currentDirectory
# buildTargets
# PLUGIN_DEV_MODE
# SITE_NAME
# SITE_TITLE
# NODE_VER

export scriptRoot=$(dirname "$(realpath "${BASH_SOURCE[0]}")")
source "$scriptRoot/.utilities"

"$scriptRoot/toggle-build-tools" --reinforce --skip-target-install

for target in "${buildTargets[@]}"; do
    (
        cd "$target" || continue

        targetName=$(basename "$target")
        sitchco_dev_deps=$(jq -r '.devDependencies // {} | keys[] | select(contains("sitchco"))' package.json)
        if [ -n "$sitchco_dev_deps" ]; then
            echo "=== Updating: ${targetName} ==="
            find . -type d -name node_modules -prune -exec rm -rf {} \;
            pnpm up ${sitchco_dev_deps} --latest
            pnpm install
        fi
        echo ""
    )
done
