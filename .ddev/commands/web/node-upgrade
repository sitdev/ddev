#!/usr/bin/env bash

## Description: Upgrade package.json

# currentDirectory
# buildTargets
# PLUGIN_DEV_MODE
# SITE_NAME
# SITE_TITLE
# NODE_VER

export scriptRoot=$(dirname "$(realpath "${BASH_SOURCE[0]}")")
source "$scriptRoot/.utilities"

if [ -d "wp-content/sitchco-packages" ]; then
    return 0    
fi

for target in "${buildTargets[@]}"; do
    (
        cd "$target" || continue

        targetName=$(basename "$target")
        sitchco_dev_deps=$(jq -r '.devDependencies // {} | keys[] | select(contains("sitchco"))' package.json)
        if [ -n "$sitchco_dev_deps" ]; then
            echo "=== Updating: ${targetName} ==="
            pkg_hash_before=$(md5sum package.json | cut -d' ' -f1)
            cp pnpm-lock.yaml pnpm-lock.yaml.bak 2>/dev/null || true
            pnpm up ${sitchco_dev_deps} --latest
            pkg_hash_after=$(md5sum package.json | cut -d' ' -f1)
            if [ "$pkg_hash_before" = "$pkg_hash_after" ]; then
                echo "No version changes, reverting lock file"
                mv pnpm-lock.yaml.bak pnpm-lock.yaml 2>/dev/null || true
            else
                rm -f pnpm-lock.yaml.bak
                find . -type d -name node_modules -prune -exec rm -rf {} \;
                pnpm install
            fi
        fi
        echo ""
    )
done
