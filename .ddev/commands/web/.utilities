#!/bin/bash
# SITE_NAME
# SITE_TITLE
# NODE_VER
# isProduction

export currentDirectory=$(pwd)
export themesDirectory=${currentDirectory}/wp-content/themes
export pluginsDirectory=${currentDirectory}/wp-content/plugins
export childThemes=$(ls -d ${themesDirectory}/*/ | grep -v orchestrator)
if [[ -f .ddev/.updated || -f .ddev/.plugin-dev-mode ]]; then
  export SOFT_RESET=1
fi
if [ -f .ddev/.updated ]; then
  export DOING_UPDATE=1
fi

getPotentialBuildDirs() {
  [[ -f webpack.config.js || -f bower.json ]] && echo ${currentDirectory}
  for theme in $childThemes; do
    [[ -f ${theme}/webpack.config.js || -f ${theme}/bower.json ]] && echo ${theme}
  done
}
export buildDirs=$(getPotentialBuildDirs)

installYarn() {
  if [ -f package.json ]; then
    [ -z $SOFT_RESET ] && yarn || yarn install --check-files 
    if [ -f bower.json ]; then
      [ -z "$(which bower)" ] && yarn global add bower || true
      bower install
    fi
  fi
}

buildYarn() {
  [ ! -z $SOFT_RESET ] && installYarn
  if [ -f package.json ]; then
    if [ -f webpack.config.js ]; then
      [ -z "${isProduction}" ] && yarn develop || yarn production
    fi
    if [ -f gulpfile.js ]; then
      [ -z "${isProduction}" ] && gulp || gulp --production
    fi
  fi
}

watchYarn() {
  if [ -f package.json ]; then
    if [ -f webpack.config.js ]; then
      yarn watch
    fi
    if [ -f gulpfile.js ]; then
      gulp watch
    fi
  fi
}
