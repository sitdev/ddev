#!/bin/bash
# SITE_NAME
# SITE_TITLE
# NODE_VER
# isProduction

export currentDirectory=$(pwd)
export themesDirectory=${currentDirectory}/wp-content/themes
export pluginsDirectory=${currentDirectory}/wp-content/plugins
export childThemes=$(ls -d ${themesDirectory}/*/ | grep -v orchestrator)
if [[ -f .ddev/.updated || -f .ddev/.plugin-dev-mode ]]; then
  export SOFT_RESET=1
fi

getPotentialBuildDirs() {
  [[ -f webpack.config.js || -f bower.json ]] && echo ${currentDirectory}
  for theme in $childThemes; do
    [[ -f ${theme}/webpack.config.js || -f ${theme}/bower.json ]] && echo ${theme}
  done
}
export buildDirs=$(getPotentialBuildDirs)

installYarn() {
  if [ -f package.json ]; then
    # Handle edge cases where there are multiple themes that may be using different build processes
    if [[ $NODE_VER == "12" && -f bower.json ]]; then
      nvm install 10
      nvm use 10
    elif [[ $NODE_VER == "10" && -f webpack.config.js ]]; then
      nvm install 12
      nvm use 12
    fi
    # Continue to normal installation
    [ -z $SOFT_RESET ] && yarn || yarn install --check-files 
    if [ -f bower.json ]; then
      [ ! -z "$(which bower)" ] || yarn global add bower
      bower install
    fi
    # Reset node version changes
    if [[ $NODE_VER == "12" && -f bower.json ]]; then
      nvm use 12
    elif [[ $NODE_VER == "10" && -f webpack.config.js ]]; then
      nvm use 10
    fi
  fi
}

buildYarn() {
  [ ! -z $SOFT_RESET ] && installYarn
  if [ -f package.json ]; then
    if [[ $NODE_VER == "12" && -f bower.json ]]; then
      nvm install 10
      nvm use 10
    elif [[ $NODE_VER == "10" && -f webpack.config.js ]]; then
      nvm install 12
      nvm use 12
    fi
    if [ -f webpack.config.js ]; then
      [ -z "${isProduction}" ] && yarn develop || yarn production
    fi
    if [ -f gulpfile.js ]; then
      [ -z "${isProduction}" ] && gulp || gulp --production
    fi
    if [[ $NODE_VER == "12" && -f bower.json ]]; then
      nvm use 12
    elif [[ $NODE_VER == "10" && -f webpack.config.js ]]; then
      nvm use 10
    fi
  fi
}

watchYarn() {
  if [ -f package.json ]; then
    if [[ $NODE_VER == "12" && -f bower.json ]]; then
      nvm install 10
      nvm use 10
    elif [[ $NODE_VER == "10" && -f webpack.config.js ]]; then
      nvm install 12
      nvm use 12
    fi
    if [ -f webpack.config.js ]; then
      yarn watch
    fi
    if [ -f gulpfile.js ]; then
      gulp watch
    fi
    if [[ $NODE_VER == "12" && -f bower.json ]]; then
      nvm use 12
    elif [[ $NODE_VER == "10" && -f webpack.config.js ]]; then
      nvm use 10
    fi
  fi
}
